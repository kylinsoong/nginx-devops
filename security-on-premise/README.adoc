= Protect Application with NGINX(On-premise)
:toc: manual

== 安装与部署

=== 把机准备

[source, bash]
.*功能测试把机*
----
docker run -itd --rm --name app-http -p 8080:8080 cloudadc/cafe:1.0
----

NOTE: Use the `ip addr add 10.1.10.172/24 dev ens33` to add multiple IP addresses to single Linux network interface.


=== 安装

[source, bash]
.*1. Install NGINX*
----
yum localinstall nginx-plus-28-1.el7.ngx.x86_64.rpm
----

[source, bash]
.*2. Install Dependencies(perl-thrift, jq)*
----
yum install epel-release -y
yum install perl-thrift -y
yum install jq -y
----

[source, bash]
.*3. Install NGINX app protect*
----
yum install `ls`
----

The rpm lists as below:

[source, bash]
----
app-protect-28+4.100.1-1.el7.ngx.x86_64.rpm
app-protect-attack-signatures-2023.01.19-1.el7.ngx.x86_64.rpm
app-protect-common-10.208.1-1.el7.ngx.x86_64.rpm
app-protect-compiler-10.208.1-1.el7.ngx.x86_64.rpm
app-protect-engine-10.208.1-1.el7.ngx.x86_64.rpm
app-protect-plugin-4.100.1-1.el7.ngx.x86_64.rpm
app-protect-threat-campaigns-2023.01.24-1.el7.ngx.x86_64.rpm
nginx-plus-module-appprotect-28+4.100.1-1.el7.ngx.x86_64.rpm
----

[source, bash]
.*4. vetify the installed rpms*
----
# rpm -qa | grep app-protect
app-protect-28+4.100.1-1.el7.ngx.x86_64
app-protect-common-10.208.1-1.el7.ngx.el7.centos.x86_64
app-protect-engine-10.208.1-1.el7.ngx.el7.centos.x86_64
app-protect-threat-campaigns-2023.01.24-1.el7.ngx.x86_64
app-protect-attack-signatures-2023.01.19-1.el7.ngx.x86_64
app-protect-compiler-10.208.1-1.el7.ngx.x86_64
app-protect-plugin-4.100.1-1.el7.ngx.x86_64

# rpm -qa | grep nginx
nginx-plus-28-1.el7.ngx.x86_64
nginx-plus-module-appprotect-28+4.100.1-1.el7.ngx.x86_64
----

=== 配置

[source, bash]
.*1. nginx.conf 中添加动态模块*
----
load_module modules/ngx_http_app_protect_module.so;
----

[source, bash]
.*2. 在 http/server/location 上下文开启应用防护*
----
app_protect_enable on;
----

[source, bash]
.*3. 在 http/server/location 上下文开启日志（输出到文件）*
----
app_protect_security_log_enable on;
app_protect_security_log "/etc/app_protect/conf/log_default.json" /var/log/app_protect/security.log;
----

[source, bash]
.*4. 启动*
----
systemctl start nginx
----

=== 测试

[source, bash]
.*1. 在 location 上下文开启应用防护*
----
    location /foo {
        status_zone status_app_foo;
        app_protect_enable on;
        proxy_pass http://backend;
    }

    location /bar {
        status_zone status_app_bar;
        proxy_pass http://backend;
    }
----

[source, bash]
.*2. 访问 foo*
----
$ curl "http://10.1.10.195:8101/foo?a="<script>"&b=1234"

<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 1386739387023060088<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

[source, bash]
.*3. 访问 bar*
----
$ curl "http://10.1.10.195:8101/bar?a=<script>&b=1234"
<br>F5 Demo App

    Request URI: /bar?a=<script>&b=1234
    Protocol: HTTP/1.0

    Server IP: 10.1.10.181
    Server Port: 8080
    Server Hostname: 10.1.10.181

    Client IP: 10.1.10.195
    Client Port: 36154
    Client Hostname: 10.1.10.195

    Session: 872FD68450D1948D778F0604A11DA9FC

    X-Forwarded-For: null

    Cookies:  

    Request Headers: host: [backend] connection: [close] user-agent: [curl/7.64.1] accept: [*/*] 
----

== 通用型防护能力

=== SQL Injection

[source, bash]
----
$ curl http://10.1.10.195:8101/foo?hfsagrs=-1+union+select+user%2Cpassword+from+users+--+
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 1386739387023062128<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Cross Site Scripting

[source, bash]
----
$ curl http://10.1.10.195:8101/foo?a="<script>"
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 1386739387023062638<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html
----

=== 目录遍历防护效果

[source, bash]
----
$ curl http://10.1.10.195:8101/foo?../../../test
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 458779997830158493<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

== 自定义策略

=== 文件类型防护

[source, bash]
.*1. 创建 /etc/app_protect/conf/filetype.json 文件*
----
{
    "name": "external_resources_file_types",
    "template": {
        "name": "POLICY_TEMPLATE_NGINX_BASE"
    },
    "applicationLanguage": "utf-8",
    "enforcementMode": "blocking",
    "blocking-settings": {
        "violations": [
            {
                "name": "VIOL_FILETYPE",
                "alarm": true,
                "block": true
            }
        ]
    },
    "filetypes": [
    {
        "name": "*",
        "type": "wildcard",
        "allowed": true,
        "checkPostDataLength": false,
        "postDataLength": 4096,
        "checkRequestLength": false,
        "requestLength": 8192,
        "checkUrlLength": true,
        "urlLength": 2048,
        "checkQueryStringLength": true,
        "queryStringLength": 2048,
        "responseCheck": false
    },
    {
        "name": "pat",
        "allowed": false
    },
    {
        "name": "mat",
        "allowed": false
    },
    {
        "name": "txt",
        "allowed": false
    }
  ]
}
----

[source, bash]
.*2. 配置 NGINX*
----
    location /foo {
        status_zone status_app_foo;
        app_protect_enable on;
        app_protect_policy_file "/etc/app_protect/conf/filetype.json" ;
        proxy_pass http://backend;
    }
----

[source, bash]
.*3. 测试*
----
$ curl http://10.1.10.195:8101/foo?../../../test ; echo
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 17432556761964223971<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

== Microservice Application Protection

=== Filter by Content

[source, bash]
.*Key Policy*
----
"rule": "content:\"test123\"; nocase;"
----

* link:filter-by-content/uds-filter-content.json[uds-filter-content.json]
* link:filter-by-content/uds-filter-content-policy.json[uds-filter-content-policy.json]
* link:filter-by-content/uds-filter-content.conf[uds-filter-content.conf]

[source, bash]
.*Test*
----
// normal request
$ curl http://10.1.10.195:8108/foo/test345
Server address: 172.17.0.2:8080
Server name: f25377244e7c
Date: 14/Mar/2023:03:12:41 +0000
URI: /foo/test345
Request ID: 46f465862262b61ab6903b8539a873b2

// risk request
$ curl http://10.1.10.195:8108/foo/test123
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 7231362286722259098<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Illegal Request Method

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/^(CONNECT|DELETE|TRACE|COPYMOVE|PUT)\\s+/\"; nocase;",
----

* link:illegal-request-method/uds-illegal-request-method.json[uds-illegal-request-method.json]
* link:illegal-request-method/uds-illegal-request-method-policy.json[uds-illegal-request-method-policy.json]
* link:illegal-request-method/illegal-request-method.conf[illegal-request-method.conf]

[source, bash]
.*Test*
----
// normal request
$ curl http://10.1.10.195:8109/foo/test -X GET
Server address: 172.17.0.2:8080
Server name: f25377244e7c
Date: 14/Mar/2023:03:24:36 +0000
URI: /foo/test
Request ID: c71d7200e7ceb9baadc952880d3886f4

// risk request
$ curl http://10.1.10.195:8109/foo/test -X DELETE
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 7231362286722261648<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== XFF Injection

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/X-Forwarded-For:.*?\\s+(select|update|union|wait|sleep|insert|chr|char|substr|substring)/\"; nocase;",
----

* link:xff-injection/uds-xff-injection.json[uds-xff-injection.json]
* link:xff-injection/uds-xff-injection-policy.json[uds-xff-injection-policy.json]
* link:xff-injection/xff-injection.conf[xff-injection.conf]

[source, bash]
.*Test*
----
// normal request
$ curl http://10.1.10.195:8110/foo/test
Server address: 172.17.0.2:8080
Server name: f25377244e7c
Date: 14/Mar/2023:03:42:49 +0000
URI: /foo/test
Request ID: 5db73250b5aa912944c7976044c04179

// risk request
$ curl -H "X-Forwarded-For: select * from t where 1 =1 " http://10.1.10.195:8110/foo/test
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 17170494753228555214<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Host Localhost

[source, bash]
.*Key Policy*
----
"rule": "uricontent:\"/test\"; nocase; objonly;"
----

* link:host-validation/uds-host-validation.json[uds-host-validation.json]
* link:host-validation/uds-host-validation-policy.json[uds-host-validation-policy.json]
* link:host-validation/host-validation.conf[host-validation.conf]

[source, bash]
.*Test*
----
$ curl -H "Host: localhost" http://10.1.10.195:8111/foo/test
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 13307705552404772574<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Illegal Directory Access

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/\\/images\\/|\\/media\\/|\\/uploads\\/|\\/pic\\/|\\/img\\/|\\/tmp\\/|\\/pictures\\//U\"; nocase; objonly; re2:\"/\\.(php|asp|aspx|jsp|jspx)$/U\"; nocase; objonly;",
----

* link:illegal-directory-access/uds-illegal-directory-access.json[uds-illegal-directory-access.json]
* link:illegal-directory-access/uds-illegal-directory-access-policy.json[uds-illegal-directory-access-policy.json]
* link:illegal-directory-access/illegal-directory-access.conf[illegal-directory-access.conf]

[source, bash]
.*Test*
----
$ curl http://10.1.10.195:8112/foo/uploads/11.jsp
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 8188505589106457781<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Weak Password

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/=(123456|default|admin888|123123|password)/\"; nocase; re2:\"/=admin/\"; nocase;",
----

* link:week-passwd/uds-week-passwd.json[uds-week-passwd.json]
* link:week-passwd/uds-week-passwd-policy.json[uds-week-passwd-policy.json]
* link:week-passwd/week-passwd.conf[week-passwd.conf]

[source, bash]
.*Test*
----
$ curl "http://10.1.10.195:8113/foo?user=admin&password=default"
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 8188505589106459311<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Illegal File Extension

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/(\\.pkcs12|\\.svn|\\.htaccess|\\.old|\\.sql|\\.bak|\\.tar|\\.pem|\\.pwd|\\.mdb|\\.der|\\.swp|\\.env|\\.yml|\\.db|\\.class|\\.dmp|\\.war|\\.idea|\\.log|\\.gz|\\.git|\\.vimrc|\\.sh|\\.DS_Store|\\.history|\\.project|\\.cgi|\\.conf|\\.pfx|\\.p12|\\.bash_history|\\.swo|\\.pl|\\.core|\\.pyc|\\.raw|\\.viminfo|\\.bp|\\.save|robots.txt)$/U\"; nocase; objonly;",
----

* link:illegal-file-extension/uds-illegal-file-extension.json[uds-illegal-file-extension.json]
* link:illegal-file-extension/uds-illegal-file-extension-policy.json[uds-illegal-file-extension-policy.json]
* link:illegal-file-extension/illegal-file-extension.conf[illegal-file-extension.conf]

[source, bash]
.*Test*
----
$ curl http://10.1.10.195:8114/foo/test.db
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 13307705552404771045<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Illegal File Type

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/\\.(php|asp|aspx)$/U\"; nocase; objonly;",
----

* link:illegal-file-type/uds-illegal-file-type.json[uds-illegal-file-type.json]
* link:illegal-file-type/uds-illegal-file-type-policy.json[uds-illegal-file-type-policy.json]
* link:illegal-file-type/illegal-file-type.conf[illegal-file-type.conf]

[source, bash]
.*Test*
----
$ curl http://10.1.10.195:8115/foo/test.php
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 13307705552404771555<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

=== Application Admin Access

[source, bash]
.*Key Policy*
----
"rule": "re2:\"/\\/redis-admin\\/|\\/axis2-web\\/|\\/axis2-admin\\/|\\/manager\\/html|\\/host-manager\\/html|\\/console\\/j_security_check|\\/ibm\\/console|\\/wp-content\\/|\\/wp-admin\\/|\\/wp-conf\\//U\"; nocase; objonly;",
----

* link:application-admin-access/uds-application-admin-access.json[uds-application-admin-access.json]
* link:application-admin-access/uds-application-admin-access-policy.json[uds-application-admin-access-policy.json]
* link:application-admin-access/application-admin-access.conf[application-admin-access.conf]

[source, bash]
.*Test*
----
$ curl http://10.1.10.195:8116/foo/redis-admin/redis
<html><head><title>Request Rejected</title></head><body>The requested URL was rejected. Please consult with your administrator.<br><br>Your support ID is: 8188505589106461351<br><br><a href='javascript:history.back();'>[Go Back]</a></body></html>
----

== OpenAPI Whitelist Policy

=== OpenAPI doc

image:openapi-whitelist-policy/api-fruits.png[]

* link:openapi-whitelist-policy/openapi-fruits.json[openapi-fruits.json]

The openapi come from `cloudadc/fruits:0.0.1`, if you run fruits on localhost:

[source, bash]
----
docker run -itd --rm --name app-fruits -p 8090:8080 cloudadc/fruits:0.0.1
----

then you openapi doc can be find at http://127.0.0.1:8090/v3/api-docs 

=== Whitelist Policy Configuration

Modify the `/etc/app_protect/conf/NginxApiSecurityPolicy.json`, either set the *open-api-files* point to openapi doc as http protocol, or as file protocol.

[source, json]
----
      "open-api-files" : [
        {
          "link": "file:///etc/app_protect/conf/openapi-fruits.json"
        }
      ],
----

[source, json]
----
      "open-api-files" : [
        {
          "link": "http://127.0.0.1:8090/v3/api-docs"
        }
      ],
----

=== Test Whitelist Policy

[source, bash]
.*Test PUT Method*
----
$ curl http://10.1.10.195:8301/fruits/ -X PUT
{"supportID": "8359298969457788494"}
----

[source, bash]
.**
----

----

[source, bash]
.**
----

----

== Binary Content filter

=== gRPC

[source, bash]
.*1. Start gRPC Server*
----
docker run -itd --rm --name grpc-server -e PORT=8009 -p 8009:8009 -d cloudadc/grpc-go-greeting:0.1 greeter_server
----

[source, bash]
.*2. NGINX Configuration*
----
server {
    listen    8301;
    server_name _;

    status_zone status_fruits;

    location / {
        status_zone status_fruits;
        app_protect_enable on;
        app_protect_policy_file "/etc/app_protect/conf/NginxApiSecurityPolicy.json";
        proxy_pass http://backendapi;
    }

}
----

* link:grpc-binary-content-filer/fruits.conf[fruits.conf]
* link:grpc-binary-content-filer/grpc-greeting.json[grpc-greeting.json]

[source, bash]
.*3. Test*
----
$ echo "ADDRESS=10.1.10.195:8401" > grpc-binary-content-filer/address 

$ docker run --env-file ./grpc-binary-content-filer/address cloudadc/grpc-go-greeting:0.1 greeter_client "This should be blocked <script>evil_script()</script>" 
2023/03/15 10:46:39 could not greet: rpc error: code = 7 desc = Blocked by NGINX App Protect, Your support ID is 3607562325608046964
----

=== Dubbo

[source, bash]
.**
----

----

[source, bash]
.**
----

----

== API Security Authentication

=== JWT Validation

[source, bash]
.*1. Generate JWK*
----
./jwkgen.sh nginxjwtauthenticationbykylin 
----

* link:jwt-validation/api.security.jwk[api.security.jwk]

NOTE: The above command geneted a `api.security.jwk`, more details about JWK refer to https://datatracker.ietf.org/doc/html/rfc7517, JWK usually can be accessed from a Zero-trust gateway, or IDP server. In this section we configured JWK on local file system. the generated `api.security.jwk` will be copy to NGINX Host.

*2. Generate JWT*

image:jwt-validation/api.security.jwt.png[]

NOTE: More details about JWT refer to https://datatracker.ietf.org/doc/html/rfc7519.

* link:jwt-validation/api.security.jwt[api.security.jwt]

To view the jwt payload run the following commands:

[source, bash]
----
CONTENT=$(cat jwt-validation/api.security.jwt);  IFS='.' ; read -r header payload signature <<< "$CONTENT" ; echo $payload | base64 --decode
----

The referrenced payload looks as below:

[source, json]
----
{
  "name": "API Security Authention",
  "sub": "ACME Corp. inc",
  "iss": "ACME Corp",
  "iat": 1678862106,
  "exp": 1708862106,
  "uid": "bbc123456"
}
----

[source, bash]
.*3. NGINX Configuration*
----
server {
  listen 8106;
  status_zone status_jwt_validation;
  location / {
    status_zone status_jwt_validation;
    auth_jwt "API Realm";
    auth_jwt_key_file api.security.jwk;
    proxy_pass http://backend;
  }
}
----

* link:jwt-validation/jwt-validation.conf[jwt-validation.conf]

[source, bash]
.*4. Test*
----
// normal request
$ curl -H "Authorization: Bearer `cat jwt-validation/api.security.jwt`" http://10.1.10.195:8106/foo/test?uid=bbc123456
Server address: 172.17.0.2:8080
Server name: 90b887d7843e
Date: 15/Mar/2023:07:39:00 +0000
URI: /foo/test?uid=bbc123456
Request ID: 1100f4eebf0df7dd0167a668aa73c74d

// risk request
$ curl -H "Authorization: Bearer abcded" http://10.1.10.195:8106/foo/test?uid=bbc123456 -I
HTTP/1.1 401 Unauthorized
Server: nginx/1.23.2
Date: Wed, 15 Mar 2023 07:41:30 GMT
Content-Type: text/html
Content-Length: 179
Connection: keep-alive
WWW-Authenticate: Bearer realm="API Realm",error="invalid_token"
----

=== JWT Dual Factor Authentication

*1. The JWT Token Payload defined a user id as authentication factor*

link:jwt-validation/api.security.jwt[api.security.jwt]

[source, bash]
.*2. NGINX Configuration*
----
js_import main from jwt.js;
js_set $jwt_claim_uid main.jwt_payload_uid;

server {
  listen 8107;
  status_zone status_jwt_dual-factor-authentication;
  location / {
    status_zone status_jwt_dual-factor-authentication_location;

    if ($jwt_claim_uid != $arg_uid) {
        return 401 "uid not align with security token governance uid";
    }

    proxy_pass http://backend;
  }
}
----

* link:jwt-dual-factor-authentication/jwt-dual-factor-authentication.conf[jwt-dual-factor-authentication.conf]
* link:jwt-dual-factor-authentication/jwt.js[jwt.js]
* link:jwt-dual-factor-authentication/api.security.jwt[api.security.jwt]

[source, bash]
.*3. Test*
----
// normal request
$ curl -H "Authorization: Bearer `cat jwt-dual-factor-authentication/api.security.jwt`" http://10.1.10.195:8107/foo/test?uid=bbc123456
Server address: 172.17.0.2:8080
Server name: 90b887d7843e
Date: 15/Mar/2023:08:15:23 +0000
URI: /foo/test?uid=bbc123456
Request ID: 7d35c94bf02956c7785147357b2f5799

// risk request
$ curl -H "Authorization: Bearer `cat jwt-dual-factor-authentication/api.security.jwt`" http://10.1.10.195:8107/foo/test?uid=bbc123 ; echo
uid not align with security token governance uid
----

=== JWT Rate Limiting

[source, bash]
.*1. JWT Token*
----
$ CONTENT=$(cat jwt-rate-limit/premium.jwt);  IFS='.' ; read -r header payload signature <<< "$CONTENT" ; echo $payload | base64 --decode
{
  "name": "API Security Authention",
  "sub": "ACME Corp. inc",
  "iss": "ACME Corp",
  "iat": 1678862106,
  "exp": 1708862106,
  "tier": "premium"
}

$ CONTENT=$(cat jwt-rate-limit/standard.jwt);  IFS='.' ; read -r header payload signature <<< "$CONTENT" ; echo $payload | base64 --decode
{
  "name": "API Security Authention",
  "sub": "ACME Corp. inc",
  "iss": "ACME Corp",
  "iat": 1678862106,
  "exp": 1708862106,
  "tier": "standard"
}
----

* link:jwt-rate-limit/premium.jwt[premium.jwt]
* link:jwt-rate-limit/standard.jwt[standard.jwt]


[source, bash]
.*2. NGINX Configuration*
----
js_import extracter from extracttier.js;
js_set $jwt_claim_tier extracter.jwt_payload_tier;

limit_req_zone $binary_remote_addr zone=standard_zone:10m rate=3r/s;
limit_req_zone $binary_remote_addr zone=premium_zone:10m rate=1000r/s;

server {
  listen 8105;
  status_zone status_jwt-rate-limit;

  location /foo {
    status_zone status_jwt-rate-limit_foo;

    if ($jwt_claim_tier = "standard" ) {
        rewrite ^.*$ /standard;
    }

    if ($jwt_claim_tier = "premium" ) {
        rewrite ^.*$ /premium;
    }

    rewrite ^.*$ /all;
  }

  location = /premium {
    limit_req zone=premium_zone burst=5 nodelay;
    proxy_pass http://backend;
  }

  location = /standard {
    limit_req zone=standard_zone burst=5 nodelay;
    proxy_pass http://backend;
  }

  location = /all {
    proxy_pass http://backend;
  }
}
----

* link:jwt-rate-limit/jwt-rate-limit.conf[jwt-rate-limit.conf]
* link:jwt-rate-limit/extracttier.js[extracttier.js]

[source, bash]
.*3. Test*
----
curl -H "Authorization: Bearer `cat jwt-rate-limit/standard.jwt`" http://10.1.10.195:8105/foo/test?uid=bbc123456

curl -H "Authorization: Bearer `cat jwt-rate-limit/premium.jwt`" http://10.1.10.195:8105/foo/test?uid=bbc123456
----

== Performance Testing


=== Prepare the Topology

[source, bash]
.*1. Create a NAT to allow backend pull docker image from internet*
----
gcloud compute routers create nat-router-us-central1 --region=us-central1 --network=default --advertisement-mode=CUSTOM --set-advertisement-ranges=10.128.0.0/20
gcloud compute routers nats create nat-us-central1 --router=nat-router-us-central1 --router-region=us-central1 --auto-allocate-nat-external-ips --nat-custom-subnet-ip-ranges=default
----

[source, bash]
.*2. Create Backend APP*
----
gcloud compute instances create-with-container backend-1 \
   --zone=us-central1-a \
   --machine-type=e2-standard-2 \
   --network-interface=private-network-ip=10.128.0.101,subnet=default,no-address \
   --image=projects/cos-cloud/global/images/cos-stable-101-17162-127-42 \
   --boot-disk-size=10GB \
   --boot-disk-type=pd-balanced \
   --boot-disk-device-name=backend-1 \
   --container-image=cloudadc/cafe:1.0 \
   --container-restart-policy=always

gcloud compute instances create-with-container backend-2 \
   --zone=us-central1-a \
   --machine-type=e2-standard-2 \
   --network-interface=private-network-ip=10.128.0.102,subnet=default,no-address \
   --image=projects/cos-cloud/global/images/cos-stable-101-17162-127-42 \
   --boot-disk-size=10GB \
   --boot-disk-type=pd-balanced \
   --boot-disk-device-name=backend-2 \
   --container-image=cloudadc/cafe:1.0 \
   --container-restart-policy=always
----

[source, bash]
.*3. Create client VM*
----
gcloud compute instances create client \
   --zone=us-central1-a \
   --machine-type=e2-standard-4 \
   --network-interface=private-network-ip=10.128.0.10,subnet=default,no-address \
   --create-disk=auto-delete=yes,boot=yes,device-name=client,image=projects/debian-cloud/global/images/debian-11-bullseye-v20230306,mode=rw,size=10,type=pd-balanced \
   --metadata=startup-script='#!/bin/bash
      apt-get update
      apt-get install -y ca-certificates curl gnupg lsb-release
      mkdir -m 0755 -p /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      docker pull cloudadc/wrk:0.1'
----

[source, bash]
.**
----

----

[source, bash]
.**
----

----

[source, bash]
.**
----

----
