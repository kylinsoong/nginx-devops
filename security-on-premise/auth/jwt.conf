
js_import main from jwt.js;
js_set $jwt_claim_uid main.jwt_payload_uid;

server {
  listen 8081;
  status_zone server_backend;
  location / {
    status_zone location_backend;
    auth_jwt "CMBC realm";
    auth_jwt_type signed;
    auth_jwt_key_file cmbc.jwk;
    proxy_pass http://backend;
  }
}

server {
  listen 8107;
  status_zone status_jwt;
  location / {
    status_zone status_jwt_location;

    if ($jwt_claim_uid != $arg_uid) {
        return 401 "uid not align with security token governance uid";
    } 

    #return 200 "ok"; 
    proxy_pass http://backend;
  }
}
