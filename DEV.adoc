= Nginx DevOps Demo
:toc: manual

== Build & Run

[source, bash]
.*Build*
----
docker build -t cloudadc/nginx-devops-demo:2.0.1 -f Dockerfile.alpine .
docker push cloudadc/nginx-devops-demo:2.0.1
----

[source, bash]
.*Run alpine*
----
docker run -it --rm --name nginx -p 8001-8020:8001-8020 -p 8443:8443 cloudadc/nginx-devops-demo:2.0.1
----

== AB Test

[source, bash]
.*1. Access A*
----
$ curl http://localhost:8002/foo -I
HTTP/1.1 200 OK
Server: nginx/1.21.6
Date: Tue, 22 Nov 2022 10:30:54 GMT
Content-Type: text/html
Content-Length: 8
Connection: keep-alive
----

[source, bash]
.*2. Set to B*
----
curl -X POST "http://localhost:8001/api/7/http/keyvals/canary" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"abswitch\": \"1\"}"
----

[source, bash]
.*3. Access B*
----
$ curl http://localhost:8002/foo -I
HTTP/1.1 404 Not Found
Server: nginx/1.21.6
Date: Tue, 22 Nov 2022 10:32:35 GMT
Content-Type: text/html
Content-Length: 7
Connection: keep-alive
----

[source, bash]
.*4. Set to A*
----
curl -X PATCH "http://localhost:8001/api/7/http/keyvals/canary" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"abswitch\": \"0\"}"
----

[source, bash]
.*5. Access A*
----
$ curl http://localhost:8002/foo -I
HTTP/1.1 200 OK
Server: nginx/1.21.6
Date: Tue, 22 Nov 2022 10:33:58 GMT
Content-Type: text/html
Content-Length: 8
Connection: keep-alive
----

== SSL

[source, bash]
.*Test SSL*
----
$ curl --cacert conf/dev/crt/example.com.crt --resolve example.com:8443:127.0.0.1 https://example.com:8443/test -v
* Added example.com:8443:127.0.0.1 to DNS cache
* Hostname example.com was found in DNS cache
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to example.com (127.0.0.1) port 8443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: conf/dev/crt/example.com.crt
  CApath: none
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* ALPN, server accepted to use http/1.1
* Server certificate:
*  subject: CN=example.com; emailAddress=ksong@example.com; O=Kylin Soong Ltd; L=Beijing; C=CN
*  start date: Nov 24 15:56:42 2022 GMT
*  expire date: Nov 21 15:56:42 2032 GMT
*  common name: example.com (matched)
*  issuer: CN=example.com; emailAddress=ksong@example.com; O=Kylin Soong Ltd; L=Beijing; C=CN
*  SSL certificate verify ok.
> GET /test HTTP/1.1
> Host: example.com:8443
> User-Agent: curl/7.64.1
> Accept: */*
> 
< HTTP/1.1 200 OK
< Server: nginx/1.21.6
< Date: Thu, 24 Nov 2022 16:20:54 GMT
< Content-Type: text/html
< Content-Length: 8
< Connection: keep-alive
< 
success
* Connection #0 to host example.com left intact
* Closing connection 0
----
